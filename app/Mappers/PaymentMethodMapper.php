<?php

namespace App\Mappers;

use App\Constants\PaymentMethods;

class PaymentMethodMapper
{

    /**
     * @var array $map
     */
    private static $map = [
        PaymentMethods::VISA => '/^4[0-9]{0,15}$/',
        PaymentMethods::MASTERCARD => '/^5[1-5][0-9]{5,}|^222[1-9][0-9]{3,}|^22[3-9][0-9]{4,}|^2[3-6][0-9]{5,}|^27[01][0-9]{4,}|^2720[0-9]{3,}$/',
        PaymentMethods::AMEX => '/^3$|^3[47][0-9]{0,13}$/',
        PaymentMethods::DISCOVER => '/^6$|^6[05]$|^601[1]?$|^65[0-9][0-9]?$|^6(?:011|5[0-9]{2})[0-9]{0,12}$/',
        PaymentMethods::JCB => '/^(?:2131|1800|35[0-9]{3})[0-9]{3,}$/',
        PaymentMethods::DINERSCLUB => '/^3(?:0[0-5]|[68][0-9])[0-9]{4,}$/',
        PaymentMethods::HIPERCARD => '/^((606282)|(637095)|(637568)|(637599)|(637609)|(637612))/',
        PaymentMethods::AURA => '/^(5078\d{2})(\d{2})(\d{11})$/',
        PaymentMethods::NARANJA => '/^(589562)/',
        PaymentMethods::CREDIMAS => '/^(50452)/',
        PaymentMethods::CABAL => '/^((627170)|(589657)|(603522)|(604((20[1-9])|(2[1-9][0-9])|(3[0-9]{2})|(400))))/',
        PaymentMethods::ELO => '/^((509091)|(636368)|(636297)|(504175)|(438935)|(40117[8-9])|(45763[1-2])|(457393)|(431274)|(50990[0-2])|'
            . '(5099[7-9][0-9])|(50996[4-9])|(509[1-8][0-9][0-9])|(5090(0[0-2]|0[4-9]|1[2-9]|[24589][0-9]|3[1-9]|6[0-46-9]|7[0-24-9]))|'
            . '(5067(0[0-24-8]|1[0-24-9]|2[014-9]|3[0-379]|4[0-9]|5[0-3]|6[0-5]|7[0-8]))|(6504(0[5-9]|1[0-9]|2[0-9]|3[0-9]))|'
            . '(6504(8[5-9]|9[0-9])|6505(0[0-9]|1[0-9]|2[0-9]|3[0-8]))|(6505(4[1-9]|5[0-9]|6[0-9]|7[0-9]|8[0-9]|9[0-8]))|'
            . '(6507(0[0-9]|1[0-8]))|(65072[0-7])|(6509(0[1-9]|1[0-9]|20))|(6516(5[2-9]|6[0-9]|7[0-9]))|(6550(0[0-9]|1[0-9]))|'
            . '(6550(2[1-9]|3[0-9]|4[0-9]|5[0-8])))/i',
        PaymentMethods::CARNET => '/^(286900|502275|506(199|2(0[1-6]|1[2-578]|2[289]|3[67]|4[579]|5[01345789]|6[1-79]|7[02-9]|8[0-7]|'
            . '9[234679])|3(0[0-9]|1[1-479]|2[0239]|3[02-79]|4[0-49]|5[0-79]|6[014-79]|7[0-4679]|8[023467]|9[1234689])|4(0[0-8]|1[0-7]|'
            . '2[0-46789]|3[0-9]|4[0-69]|5[0-79]|6[0-38]))|588772|604622|606333|627535|636(318|379)|639(388|484|559))/'
    ];

    /**
     * Map number to card method
     * @param  string $code
     * @return string
     */
    public static function toMethod(string $number): string
    {
        $result = PaymentMethods::CREDITCARD;
        foreach (static::$map as $method => $pattern) {
            if (preg_match($pattern, $number)) {
                $result = $method;
                break;
            }
        }
        return $result;
    }
}
